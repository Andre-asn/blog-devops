#!/bin/bash
# Pre-commit hook for Pylint checking
# This file is version-controlled in hooks/pre-commit
# Install with: ./hooks/install-hooks.sh

echo "ğŸ” Pre-commit: Running Pylint checks..."
echo ""

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get staged Python files
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)

if [ -z "$PYTHON_FILES" ]; then
    echo "â„¹ï¸  No Python files staged for commit."
    exit 0
fi

echo "Python files to check:"
echo "$PYTHON_FILES" | sed 's/^/  â€¢ /'
echo ""

# Check Pylint installation
if ! command -v pylint &> /dev/null; then
    echo -e "${RED}âŒ Pylint is not installed!${NC}"
    echo ""
    echo "Install with: pip install pylint"
    echo "Or if using venv: source venv/bin/activate && pip install pylint"
    exit 1
fi

# Detect if we're in a virtual environment
if [ -n "$VIRTUAL_ENV" ]; then
    echo -e "${GREEN}âœ“ Using virtual environment: ${VIRTUAL_ENV}${NC}"
elif [ -f "venv/bin/activate" ] || [ -f ".venv/bin/activate" ]; then
    echo -e "${YELLOW}âš ï¸  Virtual environment detected but not activated${NC}"
    echo "Consider activating it: source venv/bin/activate"
fi

# Temporary directory
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

ERROR_FILE="$TEMP_DIR/errors.txt"
WARNING_FILE="$TEMP_DIR/warnings.txt"

# Counters
HAS_ERRORS=0
TOTAL_FILES=0
FILES_WITH_ERRORS=0
FILES_WITH_WARNINGS=0

# Check each file
for file in $PYTHON_FILES; do
    if [ ! -f "$file" ]; then
        continue
    fi
    
    TOTAL_FILES=$((TOTAL_FILES + 1))
    echo -e "${BLUE}Checking: $file${NC}"
    
    # CRITICAL: Disable 'exit on error' before running Pylint
    set +e
    
    PYLINT_OUTPUT_FILE="$TEMP_DIR/${file//\//_}.txt"
    
    if [ -f ".pylintrc" ]; then
        pylint --rcfile=.pylintrc "$file" > "$PYLINT_OUTPUT_FILE" 2>&1
    else
        pylint "$file" > "$PYLINT_OUTPUT_FILE" 2>&1
    fi
    
    PYLINT_EXIT_CODE=$?
    
    # Re-enable 'exit on error'
    set -e
    
    # Pylint exit codes are BIT FLAGS:
    # 1  = Fatal
    # 2  = Error
    # 4  = Warning
    # 8  = Refactor
    # 16 = Convention
    # 32 = Usage error
    
    # Use bitwise AND to check for specific error flags
    HAS_FATAL=$((PYLINT_EXIT_CODE & 1))
    HAS_ERROR=$((PYLINT_EXIT_CODE & 2))
    HAS_USAGE_ERROR=$((PYLINT_EXIT_CODE & 32))
    
    if [ $PYLINT_EXIT_CODE -eq 0 ]; then
        echo -e "  ${GREEN}âœ“ No issues found${NC}"
    elif [ $HAS_FATAL -ne 0 ] || [ $HAS_ERROR -ne 0 ] || [ $HAS_USAGE_ERROR -ne 0 ]; then
        echo -e "  ${RED}âœ— ERRORS found (exit code: $PYLINT_EXIT_CODE)${NC}"
        
        # Save the full output to error file
        echo "â”â”â”â”â” $file â”â”â”â”â”" >> "$ERROR_FILE"
        cat "$PYLINT_OUTPUT_FILE" >> "$ERROR_FILE"
        echo "" >> "$ERROR_FILE"
        
        FILES_WITH_ERRORS=$((FILES_WITH_ERRORS + 1))
        HAS_ERRORS=1
    else
        echo -e "  ${YELLOW}âš  Warnings only (non-blocking, exit code: $PYLINT_EXIT_CODE)${NC}"
        
        # Save warnings
        grep -E "^[^:]+:[0-9]+:[0-9]*:? [WRC][0-9]+" "$PYLINT_OUTPUT_FILE" >> "$WARNING_FILE" 2>/dev/null || true
        FILES_WITH_WARNINGS=$((FILES_WITH_WARNINGS + 1))
    fi
done

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Display results
if [ $HAS_ERRORS -eq 1 ]; then
    echo -e "${RED}âŒ COMMIT BLOCKED: Pylint found errors!${NC}"
    echo ""
    echo "Files checked: $TOTAL_FILES"
    echo "Files with ERRORS: $FILES_WITH_ERRORS"
    echo "Files with warnings: $FILES_WITH_WARNINGS"
    echo ""
    
    if [ -f "$ERROR_FILE" ] && [ -s "$ERROR_FILE" ]; then
        echo -e "${RED}â–¼â–¼â–¼ Errors that MUST be fixed â–¼â–¼â–¼${NC}"
        echo ""
        cat "$ERROR_FILE"
        echo ""
    fi
    
    if [ -f "$WARNING_FILE" ] && [ -s "$WARNING_FILE" ]; then
        echo -e "${YELLOW}â–¼â–¼â–¼ Warnings (informational) â–¼â–¼â–¼${NC}"
        echo ""
        head -20 "$WARNING_FILE"
        WARN_COUNT=$(wc -l < "$WARNING_FILE")
        if [ $WARN_COUNT -gt 20 ]; then
            echo "... ($WARN_COUNT warnings total)"
        fi
        echo ""
    fi
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Please fix the errors above and try committing again."
    echo ""
    echo "To see full output for a file:"
    echo "  pylint <filename>"
    echo ""
    echo "To bypass this check (NOT recommended):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
else
    echo -e "${GREEN}âœ… All Pylint checks passed!${NC}"
    echo ""
    echo "Files checked: $TOTAL_FILES"
    
    if [ $FILES_WITH_WARNINGS -gt 0 ]; then
        echo "Files with warnings: $FILES_WITH_WARNINGS (non-blocking)"
        echo ""
        echo -e "${YELLOW}Note: Some warnings were found but are not blocking the commit.${NC}"
        echo "Review with: pylint <filename>"
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "âœ“ Proceeding with commit..."
    exit 0
fi
